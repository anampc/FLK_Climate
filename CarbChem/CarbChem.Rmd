---
title: "Carb_Chem"
author: "Ana Palacio-Castro & Nicole Besemer"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_height: 5
    fig_width: 7
    df_print: paged
    toc: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# 1. Libraries and settings

```{r}
# Libraries
    library(plyr)
    library(tidyverse)
    library(reshape2)
    library(ggthemes)
    library(lubridate)
    library(knitr)
```

# 2. Import the carbon chemestry data

```{r}
# Get data
CC.data<-read.csv("Data/NCRMP_CarbonateChemistryData_All_Atlantic_updated.csv", header = T)
  summary(CC.data)
  str((CC.data))

# Format variables     
  CC.data$Year<-as.numeric(CC.data$Year)
  CC.data$Aragonite_Sat_W<-as.numeric((as.character(CC.data$Aragonite_Sat_W)))
  CC.data$Temperature_C <-as.numeric((as.character(CC.data$Temperature_C)))
  CC.data$Date<-as.Date(CC.data$ESTDate, "%m/%d/%Y")
```

# 3. Data available

## Number of samples by year and region

```{r}
Cases_Reg_Year<-CC.data %>% count(Year, Region, sort = F)


Cases_Reg_Year<-Cases_Reg_Year %>%
    pivot_wider(names_from = Year, values_from = n)

kable(head(Cases_Reg_Year, format = "html"))
```

## Number of sites per region

Florida Keys 

```{r}
Cases_Site_FLK<-filter(CC.data, Region=="FLK") %>% count(Year, SiteID, sort = F)
Cases_Site_FLK

Cases_Site_FLK<-Cases_Site_FLK %>%
    pivot_wider(names_from = Year, values_from = n)

kable(head(Cases_Site_FLK, format = "html"))
```

**Note:** This looks like the original data were the SiteIDs are not curated :( 

Puerto Rico 

```{r}
Cases_Site_PR<-filter(CC.data, Region=="PR") %>% count(Year, SiteID, sort = F)
Cases_Site_PR

Cases_Site_PR<-Cases_Site_PR %>%
    pivot_wider(names_from = Year, values_from = n)

kable(head(Cases_Site_PR, format = "html"))
```

**Note:** Each sample has an unique SiteID? 

## Aragonite

```{r}
Aragonite<- ggplot(CC.data) + theme_bw() +
  
  scale_y_continuous(limits = c(0,5.5),
                       name=("Aragonite Saturation") ,
                       breaks = seq(0, 5, 1),  
                       expand = c(0, 0)) +
  scale_x_date(name="Date",
               #labels = date_format("%M/%Y"),
               #limits = c(-1,114),
               expand = c(0, 0),
               breaks ="6 months")+
  
  #scale_shape_manual(values=c(21,2,24))+
  #scale_colour_manual(values = c("gray35","gray70", "gray70"))+

geom_point(aes (Date, Aragonite_Sat_W, fill=SiteID), shape=21)+    
#geom_point(aes (Date, Aragonite_Sat_W, fill=Sample_Depth_m), shape=21)+
#geom_line(aes (Date, Aragonite_Sat_W, fill=SiteID), alpha=0.3)+

theme(legend.position="none",
          plot.background=element_blank(),
          axis.text.x = element_text(angle = 90, vjust = 0.5),
          panel.grid.major.y = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          legend.box.background = element_rect(),
          panel.background =element_rect(fill = NA, color = "black")
          ) +
  geom_abline(slope = 0, intercept = 3, color="gray", linetype=2)+
  facet_grid(Region~.)
  
Aragonite
#ggsave(file="Outputs/Aragonite.svg", plot=Aragonite, dpi = 300, width=6, height=4)

```


## Temperature

```{r}
Temperature<- ggplot(CC.data) + theme_bw() +
  
  scale_y_continuous(limits = c(15,40),
                       name=(expression("Temperature"~(degree*C))),
                       breaks = seq(16, 40, 2),  
                       expand = c(0, 0)) +
  scale_x_date(name="Date",
               #labels = date_format("%M/%Y"),
               #limits = c(-1,114),
               #expand = c(0, 0),
               breaks ="6 months")+
  
  #scale_shape_manual(values=c(21,2,24))+
  #scale_colour_manual(values = c("gray35","gray70", "gray70"))+
  
geom_point(aes (Date, Temperature_C, fill=Region), shape=21)+
#geom_line(aes (Date, Temperature_C, colour=SiteID))+
 
theme(legend.position="none",
          plot.background=element_blank(),
          axis.text.x = element_text(angle = 90, vjust = 0.5),
          panel.grid.major.y = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          legend.box.background = element_rect(),
          panel.background =element_rect(fill = NA, color = "black")
          ) 
Temperature
#ggsave(file="Outputs/Figure_1_Experiment_design.svg", plot=Design, dpi = 300, width=6, height=4)


```

**Note:** Are the 38+ data points real? 


```{r}


# Temperature data available from each treatment-replicate-day
Periods.days <- ddply (Temperature, .(Period, Treatment),summarise,
                Dmin = min (Day, na.rm = F), 
                Dmax = max (Day, na.rm = F))
Periods.days
Temperature.82<-subset(Temperature, Day=="82")
Temperature.111<-subset(Temperature, Day=="111")
Periods.82 <- ddply (Temperature.82, .(Treatment),summarise,
                Tmean = mean (Temperature, na.rm = F), 
                Tmin = min (Temperature, na.rm = F), 
                Tmax = max (Temperature, na.rm = F))
Periods.82
Periods.82 <- ddply (Temperature.82, .(Day),summarise,
                Tmean = mean (Temperature, na.rm = F), 
                Tmin = min (Temperature, na.rm = F), 
                Tmax = max (Temperature, na.rm = F))
Periods.82
Periods.82 <- ddply (Temperature.82, .(Day),summarise,
                Tmean = mean (Temperature, na.rm = F), 
                Tsd = sd (Temperature, na.rm = F))
Periods.82
Periods.110 <- ddply (Temperature.111, .(Day),summarise,
                Tmean = mean (Temperature, na.rm = F), 
                Tsd = sd (Temperature, na.rm = F))
Periods.110
```

# 3. Look at temperature conditions during each period of the experiment:
* during recovery from collection and fragmentation and 
* during the experiment (nutrient addition, ramping up, and bleaching)
* during recovery from bleaching

```{r}
Temperature_Periods_R<- ggplot(Temperature, aes (Day, Temperature, 
                                               colour=factor(Period))) +
  stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 0.2 )+
  stat_summary(fun.y=mean, geom="line") +   ggthe_bw +
  xlab("Days in the experiment")  + guides(colour=guide_legend("Period")) +
  ylab("Temperature (C)") + facet_grid(Replicate~.) 
Temperature_Periods_R
Summary_Period <- ddply (Temperature, .(Period),summarise, 
                              Temp = mean (Temperature, na.rm = T),
                              Tsd  = sd (Temperature, na.rm = T), 
                              Tmax = max (Temperature, na.rm = T),
                              Tmin = min (Temperature, na.rm = T))
Summary_Period
  
Summary_Tanks <- ddply (Temperature, .(Period, Treatment, Replicate),summarise, 
                             Temp = mean (Temperature, na.rm = T),
                             Tsd  = sd (Temperature, na.rm = T), 
                             Tmax = max (Temperature, na.rm = T),
                             Tmin = min (Temperature, na.rm = T))
Summary_Tanks
```

# 4. Get the sample times and merge them with the temperature

```{r}
Meassurments<-read.csv("Time_data.csv", header = T)
Meassurments$Date<-as.Date(Meassurments$Date)
Meassurments$Day<-as.numeric(Meassurments$Date)-17483
Meassurments$Date<-NULL
Temperature<-subset(Temperature, Day<114)
Temperature<-subset(Temperature, Day>-1)
data<-join(Temperature, Meassurments, by="Day")
```

# Figure 1: Experimental conditions
