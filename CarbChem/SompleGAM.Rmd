---
title: "BAM_Models"
author: "Ana Palacio-Castro"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    fig_height: 8
    fig_width: 8
    df_print: paged
    toc: yes
    toc_float: true
editor_options:
  chunk_output_type: console
---


```{r setup, include = FALSE}
  knitr::opts_chunk$set(warning = FALSE, 
                        message = FALSE,
                        #options(knitr.kable.NA = ''),
                        fig.align = "center")
```


```{r ibraries, include=FALSE}
library('mgcv')
library('ggplot2')
library('viridis')
theme_set(theme_bw())
library('gganimate')
library(plyr)
library(dplyr)
```

# Data 

```{r, include=FALSE}
# 1. Get data
WS.data<-read.csv("WS.data.csv", header = T)

# Separate CalVal and Walton Smith data
summary(WS.data$Mission)
summary(WS.data$Extreme)

```

## Create time variables for the GAM

```{r}
WS.data <- transform(WS.data,
                       datetime = as.POSIXct(paste(ESTDate, EST.Time),
                                             format = '%m/%d/%Y %I:%M:%S %p', tz = "EST"))
summary(WS.data$datetime)
WS.data <- transform(WS.data,
                       SiteID = factor(SiteID),
                       MoY = as.numeric(format(datetime, format = '%m')),
                       #DoY = as.numeric(format(datetime, format = '%j')),
                       ToD = as.numeric(format(datetime, format = '%H')) +
                         (as.numeric(format(datetime, format = '%M')) / 60))
```


## Subset FLK data by zone to use them as endpoints

```{r}
  WS.open<-subset(WS.data, WS.data$Zone=="Offshore"|WS.data$Zone=="Oceanic")
  WS.open<-subset(WS.open, WS.open$Extreme=="Normal")
  WS.open$Date<-as.Date(WS.open$Date, "%Y-%m-%d")
 
  WS.reef<-subset(WS.data, WS.data$Zone=="Inshore"|WS.data$Zone=="Mid channel")
  WS.reef<-subset(WS.reef, WS.reef$Extreme=="Normal")
  WS.reef$Date<-as.Date(WS.reef$Date, "%Y-%m-%d")
```

* Get the oceanic / offshore mean values per monty-year and substract them from the reef data

**Quick plote / note about Time of the day:** Either hour of the day does not matter for temperature (lots of circulation?) or times are not very accurate (Waton Smith UTC reporting not always followed?) 

## Check undesirable patters in the data

### Time of the day

```{r}
ToDay<-ggplot(WS.data, aes(ToD, Aragonite_Sat_W)) +
  geom_smooth() +
  theme(panel.border = element_blank(),
        panel.background = element_blank(),
        panel.grid.minor = element_line(colour = "grey90"),
        panel.grid.major = element_line(colour = "grey90"),
        panel.grid.major.x = element_line(colour = "grey90"),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 12, face = "bold")) + facet_wrap(~MoY)
ToDay + geom_point(aes(colour=Zone))
ToDay + geom_point(aes(colour=Sub_region, shape=File_Origin))
```

### Time of the day

```{r}
MoYear<-ggplot(WS.data, aes(MoY, Aragonite_Sat_W)) +
  geom_smooth() +
  theme(panel.border = element_blank(),
        panel.background = element_blank(),
        panel.grid.minor = element_line(colour = "grey90"),
        panel.grid.major = element_line(colour = "grey90"),
        panel.grid.major.x = element_line(colour = "grey90"),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 12, face = "bold"))
MoYear + geom_point(aes(colour=Zone))+facet_wrap(~Sub_region)
MoYear + geom_point(aes(colour=Year, shape=File_Origin)) +facet_wrap(~Sub_region)
```

# Generalized additive models (GAMs) for fitting irregular time series

## Notes

The principle behind GAMs is similar to that of regression, except that instead of summing effects of individual predictors, GAMs are a sum of smooth functions. Functions allow us to model more complex patterns, and they can be averaged to obtain smoothed curves that are more generalizable. Because GAMs are based on functions rather than variables, they are not restricted by the linearity assumption in regression that requires predictor and outcome variables to move in a straight line. Furthermore, unlike in neural networks, we can isolate and study effects of individual functions in a GAM on resulting predictions.

* model the response variable by independent variables, which are in the form of some smooth functions
* Smooth functions are also called splines. Smoothing splines are real functions that are piecewise-defined by polynomial functions (basis functions). The places, where the polynomial pieces connect are called knots. In GAMs, penalized regression splines are used in order to regularize the smoothness of a spline.


There are several smoothing bases b (splines) which are suitable for regression:
* thin plate regression
* cubic regression
* cyclic cubic regression 
* P-splines

bs="tp": Low rank isotropic smoothers of any number of covariates. 

* Isotropic = rotation of the covariate co-ordinate system will not change the result of smoothing
* Low rank = they have far fewer coefficients than there are data to smooth. They are reduced rank versions of the thin plate splines and use the thin plate spline penalty. 
* They are the default smooth for s terms because there is a defined sense in which they are the optimal smoother of any given basis dimension/rank (Wood, 2003).
* Thin plate regression splines do not have ‘knots’ (at least not in any conventional sense): a truncated eigen-decomposition is used to achieve the rank reduction. See tprs for further details.

bs="ts" is as "tp" but with a modification to the smoothing penalty, so that the null space is also penalized slightly and the whole term can therefore be shrunk to zero.

Duchon splines: bs="ds". LONGITUD AND LATITUD
* Thin plate splines. For any given number of covariates they allow lower orders of derivative in the penalty than thin plate splines (and hence a smaller null space). See Duchon.spline for further details.


Smoothing parameter (λ) and the number of basis dimensions (i.e. degrees of freedom):
* GAM uses Generalized Cross Validation score (GCV) to minimize vg
* when lambda is near 1 then spline will be over-smoothed
* when lambda is near zero than spline isn’t penalized, so the method behaves like a classical OLS.
* With a number of basis dimensions (estimated degrees of freedom), it is opposite. Higher dimension implies that fit will be less smoothed (overfit), on the other side lower dimensions implies more smoothed behavior of fitted values.

Interactions:
* Multiplication of two independent variables
* smoothed function to one variable
* same smoothed function for both variables: 
* tensor product interactions: different smoothing bases for variables and penalize it in two (when we do interactions of two independent variables) different ways: 



# GAM models with bam

All these models below include location as coordinates and not as categories in Zone (In- off-shore. etc), UK, MK and LK. That might be better or not?

Number of years, monts (of the year) and time of the day (useless) in the data

```{r model parameters}

n_Year <- unique(WS.data[, "Year"])
length(n_Year) 

n_MoY <- unique(WS.data[, "MoY"])
length(n_MoY)

n_ToD <- unique(WS.data [, "ToD"])
length(n_ToD)

N <- nrow(WS.data) # number of observations in the train set
period<-N/(length(n_Year))/12
period<-round(period)
window <- N / period # number of days in the train set

knots <- list(DoY = c(0.5, 366.5))
M <- list(c(1, 0.5), NA)

```


## Omega -off

```{r}
# 1. Model - Open
m_1 <- bam(Aragonite_Sat_W  ~
           s(MoY, k = 6, bs = 'cc') +  # Month of the year?
           s(Year, k = 5) +
           ti(MoY, Year, bs = c('cc', 'tp'), k = c(5, 4)),
      data = WS.open, method = 'fREML', knots = knots, nthreads = 4, discrete = TRUE)
summary(m_1)

m_omega <-m_1

par(mfrow=c(2,2))
gam.check(m_omega)
par(mfrow=c(1,1))

# 2. Effects
  #plot(m_pCO2, pages = 1, scheme = 2, shade = TRUE, scale = 0)
  plot(m_omega, pages = 1, scheme = 2, shade = TRUE)
  
  #ToD and MoY
  vis.gam(m_omega, view=c("Year","MoY"), main = "Omega", plot.type = "contour",
          color = "terrain", contour.col = "black", lwd = 2)


pdata <- with(WS.open,
              expand.grid(ToD = 24,
                          MoY = seq(1, 12, by = 1),
                          Year = seq(min(Year), max(Year), by = 1)))
fit <- data.frame(predict(m_omega, newdata = pdata, se.fit = TRUE))
fit <- transform(fit, upper = fit + (2 * se.fit), lower = fit - (2 * se.fit))
pred <- cbind(pdata, fit)

ggplot(pred, aes(x = MoY, y = fit, group = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line() + facet_wrap(~ Year) +
  labs(x = NULL, y = expression("Aragonite saturation state "~Omega))

ggplot(pred, aes(x = MoY, y = fit, group = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper,  fill = factor(Year)), alpha = 0.5) +
  geom_line()+
  labs(x = NULL, y = expression("Aragonite saturation state "~Omega))

```

## Omega - reef

```{r}
# 1. Model
m_2 <- bam(Aragonite_Sat_W  ~
           s(MoY, k = 6, bs = 'cc') +  # Month of the year?
           s(Year, k = 5) +
           ti(MoY, Year, bs = c('cc', 'tp'), k = c(5, 4)),
      data = WS.reef, method = 'fREML', knots = knots, nthreads = 4, discrete = TRUE)
summary(m_2)

m_omega_reef <-m_2

par(mfrow=c(2,2))
gam.check(m_omega_reef)
par(mfrow=c(1,1))

# 2. Effects
  #plot(m_pCO2, pages = 1, scheme = 2, shade = TRUE, scale = 0)
  plot(m_omega_reef, pages = 1, scheme = 2, shade = TRUE)
  
  #ToD and MoY
  vis.gam(m_omega_reef, view=c("Year","MoY"), main = "Omega", plot.type = "contour",
          color = "terrain", contour.col = "black", lwd = 2)


pdata <- with(WS.reef,
              expand.grid(ToD = 24,
                          MoY = seq(1, 12, by = 1),
                          Year = seq(min(Year), max(Year), by = 1)))
fit <- data.frame(predict(m_omega_reef, newdata = pdata, se.fit = TRUE))
fit <- transform(fit, upper = fit + (2 * se.fit), lower = fit - (2 * se.fit))
pred <- cbind(pdata, fit)

ggplot(pred, aes(x = MoY, y = fit, group = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line() + facet_wrap(~ Year) +
  labs(x = NULL, y = expression("Aragonite saturation state "~Omega))

ggplot(pred, aes(x = MoY, y = fit, group = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper,  fill = factor(Year)), alpha = 0.5) +
  geom_line()+
  labs(x = NULL, y = expression("Aragonite saturation state "~Omega))

```

## pCO2 - Off

```{r}
# 1. Model

mpCO2_Off <- bam(pCO2  ~
           s(MoY, k = 6, bs = 'cc') +  # Month of the year?
           s(Year, k = 5) +
           ti(MoY, Year, bs = c('cc', 'tp'), k = c(5, 4)), 
      data = WS.open, method = 'fREML', knots = knots, nthreads = 4, discrete = TRUE)
summary(mpCO2_Off)

gam.check(mpCO2_Off)

# 2. Effects
  #plot(m_omega, pages = 1, scheme = 2, shade = TRUE, scale = 0)
  plot(mpCO2_Off, pages = 1, scheme = 2, shade = TRUE)
  
  # vis.gam(mpCO2_Off, 
  #         n.grid = 50, theta = 35, phi = 32, zlab = "",
  #       ticktype = "detailed", color = "topo", main = "t2(D, W)")
  # 
  vis.gam(mpCO2_Off, view=c("Year","MoY"), main = "pCO2", plot.type = "contour",
        color = "terrain", contour.col = "black", lwd = 2)


# 3. Predictions 

# 3.1 spatial pattern and how they vary over the years -> predict from the model for a 100x100 grid over the spatial domain, at midday on month 1 of each year:

pdata <- with(WS.open,
              expand.grid(ToD = 12,
                          MoY = seq(1, 12, by = 1),
                          Year = seq(min(Year), max(Year), by = 1)))
fit <- data.frame(predict(mpCO2_Off, newdata = pdata, se.fit = TRUE))
fit <- transform(fit, upper = fit + (2 * se.fit), lower = fit - (2 * se.fit))
pred <- cbind(pdata, fit)

ggplot(pred, aes(x = Year, y = fit, group = factor(MoY))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line() + facet_wrap(~ MoY) +
  labs(x = NULL, y = expression(pCO2))

ggplot(pred, aes(x = MoY, y = fit, group = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line() + facet_wrap(~ Year) +
  labs(x = "Month", y = expression(pCO2))

ggplot(pred, aes(x = MoY, y = fit, colour = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line()+
  labs(x = "Month", y = expression(pCO2))

```


## pCO2 - Inn

```{r}
# 1. Model

mpCO2_Inn <- bam(pCO2  ~
           s(MoY, k = 6, bs = 'cc') +  # Month of the year?
           s(Year, k = 5) +
           ti(MoY, Year, bs = c('cc', 'tp'), k = c(5, 4)), 
      data = WS.reef, method = 'fREML', knots = knots, nthreads = 4, discrete = TRUE)
summary(mpCO2_Inn)

gam.check(mpCO2_Inn)

# 2. Effects
  #plot(m_omega, pages = 1, scheme = 2, shade = TRUE, scale = 0)
  plot(mpCO2_Inn, pages = 1, scheme = 2, shade = TRUE)
  
  # vis.gam(mpCO2_Inn, 
  #         n.grid = 50, theta = 35, phi = 32, zlab = "",
  #       ticktype = "detailed", color = "topo", main = "t2(D, W)")
  # 
  vis.gam(mpCO2_Inn, view=c("Year","MoY"), main = "pCO2", plot.type = "contour",
        color = "terrain", contour.col = "black", lwd = 2)


# 3. Predictions 

# 3.1 spatial pattern and how they vary over the years -> predict from the model for a 100x100 grid over the spatial domain, at midday on month 1 of each year:

pdata <- with(WS.reef,
              expand.grid(ToD = 20,
                          MoY = seq(1, 12, by = 1),
                          Year = seq(min(Year), max(Year), by = 1)))
fit <- data.frame(predict(mpCO2_Inn, newdata = pdata, se.fit = TRUE))
fit <- transform(fit, upper = fit + (2 * se.fit), lower = fit - (2 * se.fit))
pred <- cbind(pdata, fit)

ggplot(pred, aes(x = Year, y = fit, group = factor(MoY))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line() + facet_wrap(~ MoY) +
  labs(x = NULL, y = expression(pCO2))

ggplot(pred, aes(x = MoY, y = fit, group = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line() + facet_wrap(~ Year) +
  labs(x = "Month", y = expression(pCO2))

ggplot(pred, aes(x = MoY, y = fit, colour = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line()+
  labs(x = "Month", y = expression(pCO2))

```

## pH - Off

```{r}
# 1. Model

mpH_Off <- bam(pH  ~
           s(MoY, k = 6, bs = 'cc') +  # Month of the year?
           s(Year, k = 5) +
           ti(MoY, Year, bs = c('cc', 'tp'), k = c(5, 4)),
           #ti(Longitude, Latitude, Year, d = c(2,1), bs = c('ds','tp'), 
            #  m = M, k = c(15, 5)),
data = WS.open, method = 'fREML', knots = knots, nthreads = 4, discrete = TRUE)
summary(mpH_Off)

gam.check(mpH_Off)

# 2. Effects
  #plot(m_omega, pages = 1, scheme = 2, shade = TRUE, scale = 0)
  plot(mpH_Off, pages = 1, scheme = 2, shade = TRUE)
  
  vis.gam(mpH_Off, view=c("Year","MoY"), n.grid = 50, theta = 35, phi = 32, zlab = "",
        ticktype = "detailed", color = "topo", main = "t2(D, W)")
  
  vis.gam(mpH_Off, view=c("Year","MoY"), main = "pH", plot.type = "contour",
        color = "terrain", contour.col = "black", lwd = 2)

# 3. Predictions 


# 3.2 Long-term trends in more detail ->  predict for particular stations and months 
# chose (midday, on month of year 1, 4, 7, and 10, at the selected station, and evaluating the long-term trend at 30 equally spaced values)

pdata <- with(WS.open,
              expand.grid(ToD = 12,
                          MoY = seq(1, 12, by =1),
                          Year = seq(min(Year), max(Year), by =1)))
                          #Longitude = -80.4,
                          #Latitude  = 25.1))
fit <- data.frame(predict(mpH_Off, newdata = pdata, se.fit = TRUE))
fit <- transform(fit, upper = fit + (2 * se.fit), lower = fit - (2 * se.fit))
pred <- cbind(pdata, fit)

ggplot(pred, aes(x = Year, y = fit, group = factor(MoY))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line() + facet_wrap(~ MoY) +
  labs(x = NULL, y = expression(pH))

ggplot(pred, aes(x = MoY, y = fit, group = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line() + facet_wrap(~ Year) +
  labs(x = "Month", y = expression(pH))

ggplot(pred, aes(x = MoY, y = fit, colour = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line()+
  labs(x = "Month", y = expression(pH))

```



## pH - Inn

```{r}
# 1. Model

mpH_Inn <- bam(pH  ~
           s(MoY, k = 6, bs = 'cc') +  # Month of the year?
           s(Year, k = 5) +
           ti(MoY, Year, bs = c('cc', 'tp'), k = c(5, 4)),
           #ti(Longitude, Latitude, Year, d = c(2,1), bs = c('ds','tp'), 
            #  m = M, k = c(15, 5)),
data = WS.reef, method = 'fREML', knots = knots, nthreads = 4, discrete = TRUE)
summary(mpH_Inn)

gam.check(mpH_Inn)

# 2. Effects
  #plot(m_omega, pages = 1, scheme = 2, shade = TRUE, scale = 0)
  plot(mpH_Inn, pages = 1, scheme = 2, shade = TRUE)
  
  vis.gam(mpH_Inn, view=c("Year","MoY"), n.grid = 50, theta = 35, phi = 32, zlab = "",
        ticktype = "detailed", color = "topo", main = "t2(D, W)")
  
  vis.gam(mpH_Inn, view=c("Year","MoY"), main = "pH", plot.type = "contour",
        color = "terrain", contour.col = "black", lwd = 2)

# 3. Predictions 


# 3.2 Long-term trends in more detail ->  predict for particular stations and months 
# chose (midday, on month of year 1, 4, 7, and 10, at the selected station, and evaluating the long-term trend at 30 equally spaced values)

pdata <- with(WS.reef,
              expand.grid(ToD = 12,
                          MoY = seq(1, 12, by =1),
                          Year = seq(min(Year), max(Year), by =1)))
                          #Longitude = -80.4,
                          #Latitude  = 25.1))
fit <- data.frame(predict(mpH_Inn, newdata = pdata, se.fit = TRUE))
fit <- transform(fit, upper = fit + (2 * se.fit), lower = fit - (2 * se.fit))
pred <- cbind(pdata, fit)

ggplot(pred, aes(x = Year, y = fit, group = factor(MoY))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line() + facet_wrap(~ MoY) +
  labs(x = NULL, y = expression(pH))

ggplot(pred, aes(x = MoY, y = fit, group = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line() + facet_wrap(~ Year) +
  labs(x = "Month", y = expression(pH))

ggplot(pred, aes(x = MoY, y = fit, colour = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line()+
  labs(x = "Month", y = expression(pH))

```

## nDIC off

```{r}
# 1. Model

mnDIC_Off <- bam(nDIC  ~
         # s(ToD, k = 12, bs = 'cc') + # Time of the day
          s(MoY, k = 6, bs = 'cc') +  # Month of the year?
          s(Year, k = 5) +
          ti(MoY, Year, bs = c('cc', 'tp'), k = c(5, 4)),
data = WS.open, method = 'fREML', knots = knots, nthreads = 4, discrete = TRUE)
summary(mnDIC_Off)

gam.check(mnDIC_Off)

# 2. Effects
  #plot(m_omega, pages = 1, scheme = 2, shade = TRUE, scale = 0)
  plot(mnDIC_Off, pages = 1, scheme = 2, shade = TRUE)
  
  vis.gam(mnDIC_Off, view=c("Year","MoY"), n.grid = 50, theta = 35, phi = 32, zlab = "",
        ticktype = "detailed", color = "topo", main = "t2(D, W)")
  vis.gam(mnDIC_Off, view=c("Year","MoY"), main = "nDIC", plot.type = "contour",
        color = "terrain", contour.col = "black", lwd = 2)

# 3. Predictions 

pdata <- with(WS.open,
              expand.grid(ToD = 12,
                          MoY = c(1,2, 3, 4, 5, 6, 7,8, 9,10, 11, 12),
                          Year = seq(min(Year), max(Year), by = 1)))
fit <- data.frame(predict(mnDIC_Off, newdata = pdata, se.fit = TRUE))
fit <- transform(fit, upper = fit + (2 * se.fit), lower = fit - (2 * se.fit))
pred <- cbind(pdata, fit)

ggplot(pred, aes(x = Year, y = fit, group = factor(MoY))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line() + facet_wrap(~ MoY) +
  labs(x = NULL, y = expression(nDIC))

ggplot(pred, aes(x = MoY, y = fit, group = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line() + facet_wrap(~ Year) +
  labs(x = "Month", y = expression(nDIC))

ggplot(pred, aes(x = MoY, y = fit, colour = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line()+
  labs(x = "Month", y = expression(nDIC))

```
## nDIC inn

```{r}
# 1. Model

mnDIC_Inn <- bam(nDIC  ~
         # s(ToD, k = 12, bs = 'cc') + # Time of the day
          s(MoY, k = 6, bs = 'cc') +  # Month of the year?
          s(Year, k = 5) +
          ti(MoY, Year, bs = c('cc', 'tp'), k = c(5, 4)),
data = WS.reef, method = 'fREML', knots = knots, nthreads = 4, discrete = TRUE)
summary(mnDIC_Inn)

gam.check(mnDIC_Inn)

# 2. Effects
  #plot(m_omega, pages = 1, scheme = 2, shade = TRUE, scale = 0)
  plot(mnDIC_Inn, pages = 1, scheme = 2, shade = TRUE)
  
  vis.gam(mnDIC_Off, view=c("Year","MoY"), n.grid = 50, theta = 35, phi = 32, zlab = "",
        ticktype = "detailed", color = "topo", main = "t2(D, W)")
  vis.gam(mnDIC_Inn, view=c("Year","MoY"), main = "nDIC", plot.type = "contour",
        color = "terrain", contour.col = "black", lwd = 2)

# 3. Predictions 

pdata <- with(WS.reef,
              expand.grid(ToD = 12,
                          MoY = c(1,2, 3, 4, 5, 6, 7,8, 9,10, 11, 12),
                          Year = seq(min(Year), max(Year), by = 1)))
fit <- data.frame(predict(mnDIC_Inn, newdata = pdata, se.fit = TRUE))
fit <- transform(fit, upper = fit + (2 * se.fit), lower = fit - (2 * se.fit))
pred <- cbind(pdata, fit)

ggplot(pred, aes(x = Year, y = fit, group = factor(MoY))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line() + facet_wrap(~ MoY) +
  labs(x = NULL, y = expression(nDIC))

ggplot(pred, aes(x = MoY, y = fit, group = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line() + facet_wrap(~ Year) +
  labs(x = "Month", y = expression(nDIC))

ggplot(pred, aes(x = MoY, y = fit, colour = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line()+
  labs(x = "Month", y = expression(nDIC))

```


## nTA - off

```{r}
# 1. Model

mnTA_Off <- bam(nTA  ~
           #s(ToD, k = 12, bs = 'cc') + # Time of the day
           s(MoY, k = 6, bs = 'cc') +  # Month of the year?
           s(Year, k = 5) +
           ti(MoY, Year, bs = c('cc', 'tp'), k = c(5, 4)),
        data = WS.open, method = 'fREML', knots = knots, nthreads = 4, discrete = TRUE)
summary(mnTA_Off)

gam.check(mnTA_Off)

# 2. Effects
  #plot(m_omega, pages = 1, scheme = 2, shade = TRUE, scale = 0)
  plot(mnTA_Off, pages = 1, scheme = 2, shade = TRUE)
  
  vis.gam(mnTA_Off, n.grid = 50, theta = 35, phi = 32, zlab = "",
        ticktype = "detailed", color = "topo", main = "t2(D, W)")
  vis.gam(mnTA_Off, view=c("Year","MoY"), main = "nTA", plot.type = "contour",
        color = "terrain", contour.col = "black", lwd = 2)


# 3. Predictions 
pdata <- with(WS.open,
              expand.grid(ToD = 12,
                          MoY = seq(1, 12, by = 1),
                          Year = seq(min(Year), max(Year), by = 1)))
fit <- data.frame(predict(mnTA_Off, newdata = pdata, se.fit = TRUE))
fit <- transform(fit, upper = fit + (2 * se.fit), lower = fit - (2 * se.fit))
pred <- cbind(pdata, fit)

ggplot(pred, aes(x = Year, y = fit, group = factor(MoY))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line() + facet_wrap(~ MoY) +
  labs(x = NULL, y = expression(nTA))

ggplot(pred, aes(x = MoY, y = fit, group = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line() + facet_wrap(~ Year) +
  labs(x = "Month", y = expression(nTA))

ggplot(pred, aes(x = MoY, y = fit, colour = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line()+
  labs(x = "Month", y = expression(nTA))

```


## nTA - inn

```{r}
# 1. Model

mnTA_Inn <- bam(nTA  ~
           #s(ToD, k = 12, bs = 'cc') + # Time of the day
           s(MoY, k = 6, bs = 'cc') +  # Month of the year?
           s(Year, k = 5) +
           ti(MoY, Year, bs = c('cc', 'tp'), k = c(5, 4)),
        data = WS.reef, method = 'fREML', knots = knots, nthreads = 4, discrete = TRUE)
summary(mnTA_Inn)

gam.check(mnTA_Inn)

# 2. Effects
  #plot(m_omega, pages = 1, scheme = 2, shade = TRUE, scale = 0)
  plot(mnTA_Inn, pages = 1, scheme = 2, shade = TRUE)
  
  vis.gam(mnTA_Inn, n.grid = 50, theta = 35, phi = 32, zlab = "",
        ticktype = "detailed", color = "topo", main = "t2(D, W)")
  vis.gam(mnTA_Inn, view=c("Year","MoY"), main = "nTA", plot.type = "contour",
        color = "terrain", contour.col = "black", lwd = 2)


# 3. Predictions 
pdata <- with(WS.reef,
              expand.grid(ToD = 12,
                          MoY = seq(1, 12, by = 1),
                          Year = seq(min(Year), max(Year), by = 1)))
fit <- data.frame(predict(mnTA_Inn, newdata = pdata, se.fit = TRUE))
fit <- transform(fit, upper = fit + (2 * se.fit), lower = fit - (2 * se.fit))
pred <- cbind(pdata, fit)

ggplot(pred, aes(x = Year, y = fit, group = factor(MoY))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line() + facet_wrap(~ MoY) +
  labs(x = NULL, y = expression(nTA))

ggplot(pred, aes(x = MoY, y = fit, group = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line() + facet_wrap(~ Year) +
  labs(x = "Month", y = expression(nTA))

ggplot(pred, aes(x = MoY, y = fit, colour = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line()+
  labs(x = "Month", y = expression(nTA))

```


## Omega - delta

```{r}
# 1. Model

head(WS.reef)
m_2 <- bam(dOmega_MY  ~
           s(MoY, k = 6, bs = 'cc') +  # Month of the year?
           s(Year, k = 5) +
           ti(MoY, Year, bs = c('cc', 'tp'), k = c(5, 4)),
      data = WS.reef, method = 'fREML', knots = knots, nthreads = 4, discrete = TRUE)
summary(m_2)

m_omega_reef <-m_2

par(mfrow=c(2,2))
gam.check(m_omega_reef)
par(mfrow=c(1,1))

# 2. Effects
  #plot(m_pCO2, pages = 1, scheme = 2, shade = TRUE, scale = 0)
  plot(m_omega_reef, pages = 1, scheme = 2, shade = TRUE)
  
  #ToD and MoY
  vis.gam(m_omega_reef, view=c("Year","MoY"), main = "Omega", plot.type = "contour",
          color = "terrain", contour.col = "black", lwd = 2)


pdata <- with(WS.reef,
              expand.grid(ToD = 24,
                          MoY = seq(1, 12, by = 1),
                          Year = seq(min(Year), max(Year), by = 1)))
fit <- data.frame(predict(m_omega_reef, newdata = pdata, se.fit = TRUE))
fit <- transform(fit, upper = fit + (2 * se.fit), lower = fit - (2 * se.fit))
pred <- cbind(pdata, fit)

ggplot(pred, aes(x = MoY, y = fit, group = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line() + facet_wrap(~ Year) +
  labs(x = NULL, y = expression("Aragonite saturation state "~Omega))

ggplot(pred, aes(x = MoY, y = fit, group = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper,  fill = factor(Year)), alpha = 0.5) +
  geom_line()+
  labs(x = NULL, y = expression("Aragonite saturation state "~Omega))

```



## nTA - delta

```{r}
# 1. Model

head(WS.reef)
dTA_2 <- bam(dnTA_MY  ~
           s(MoY, k = 6, bs = 'cc') +  # Month of the year?
           s(Year, k = 5) +
           ti(MoY, Year, bs = c('cc', 'tp'), k = c(5, 4)),
      data = WS.reef, method = 'fREML', knots = knots, nthreads = 4, discrete = TRUE)
summary(dTA_2)

par(mfrow=c(2,2))
gam.check(dTA_2)
par(mfrow=c(1,1))

# 2. Effects
  #plot(m_pCO2, pages = 1, scheme = 2, shade = TRUE, scale = 0)
  plot(dTA_2, pages = 1, scheme = 2, shade = TRUE)
  
  #ToD and MoY
  vis.gam(dTA_2, view=c("Year","MoY"), main = "d nTA", plot.type = "contour",
          color = "terrain", contour.col = "black", lwd = 2)


pdata <- with(WS.reef,
              expand.grid(ToD = 24,
                          MoY = seq(1, 12, by = 1),
                          Year = seq(min(Year), max(Year), by = 1)))
fit <- data.frame(predict(dTA_2, newdata = pdata, se.fit = TRUE))
fit <- transform(fit, upper = fit + (2 * se.fit), lower = fit - (2 * se.fit))
pred <- cbind(pdata, fit)

ggplot(pred, aes(x = MoY, y = fit, group = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line() + facet_wrap(~ Year) +
  labs(x = NULL, y = expression(Delta~"nTA"))

ggplot(pred, aes(x = MoY, y = fit, group = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper,  fill = factor(Year)), alpha = 0.5) +
  geom_line()+
  labs(x = NULL, y = expression(Delta~"nTA"))

```


## nDIC - delta

```{r}
# 1. Model

head(WS.reef)
dDIC_2 <- bam(dnDIC_MY  ~
           s(MoY, k = 6, bs = 'cc') +  # Month of the year?
           s(Year, k = 5) +
           ti(MoY, Year, bs = c('cc', 'tp'), k = c(5, 4)),
      data = WS.reef, method = 'fREML', knots = knots, nthreads = 4, discrete = TRUE)
summary(dDIC_2)

par(mfrow=c(2,2))
gam.check(dDIC_2)
par(mfrow=c(1,1))

# 2. Effects
  #plot(m_pCO2, pages = 1, scheme = 2, shade = TRUE, scale = 0)
  plot(dDIC_2, pages = 1, scheme = 2, shade = TRUE)
  
  #ToD and MoY
  vis.gam(dDIC_2, view=c("Year","MoY"), main = "d nDIC", plot.type = "contour",
          color = "terrain", contour.col = "black", lwd = 2)


pdata <- with(WS.reef,
              expand.grid(ToD = 24,
                          MoY = seq(1, 12, by = 1),
                          Year = seq(min(Year), max(Year), by = 1)))
fit <- data.frame(predict(dDIC_2, newdata = pdata, se.fit = TRUE))
fit <- transform(fit, upper = fit + (2 * se.fit), lower = fit - (2 * se.fit))
pred <- cbind(pdata, fit)

ggplot(pred, aes(x = MoY, y = fit, group = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5) +
  geom_line() + facet_wrap(~ Year) +
  labs(x = NULL, y = expression(Delta~"nTA"))

ggplot(pred, aes(x = MoY, y = fit, group = factor(Year))) +
  geom_ribbon(aes(ymin = lower, ymax = upper,  fill = factor(Year)), alpha = 0.5) +
  geom_line()+
  labs(x = NULL, y = expression(Delta~"nDIC"))

```

