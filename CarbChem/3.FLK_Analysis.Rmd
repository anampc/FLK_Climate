---
title: "Carbon Chemestry FLK"
author: "Ana Palacio-Castro"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    fig_height: 8
    fig_width: 8
    df_print: paged
    toc: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include = FALSE}
  knitr::opts_chunk$set(warning = FALSE, 
                        message = FALSE,
                        #options(knitr.kable.NA = ''),
                        fig.align = "center")
```

# Libraries and settings

```{r, include=FALSE}
# Libraries
    library(plyr)
    library(tidyverse)
    library(reshape2)
    library(ggthemes)
    library(lubridate)
    library(knitr)
    library(dplyr)
    library(broom)
    library(lmerTest)

# Interactive Maps
    library(leaflet)
```

# Import and format carbon chemestry data

```{r, include=FALSE}
# 1. Get data
CC.data<-read.csv("CC.data_normalized.csv", header = T)
  summary(CC.data)
  str((CC.data))
  #summary(CC.data$Region)
  #summary(CC.data$Location)
  Sites<-as.data.frame(unique(CC.data$SiteID))

# 2. Format variables
  # Date/times
  CC.data$Year<-as.numeric(CC.data$Year)
  CC.data$Date<-as.Date(as.character(CC.data$ESTDate), "%m/%d/%Y")
 
  
  # Numerical data
  CC.data$Latitude <- gsub("N/A", "NA", CC.data$Latitude)
  CC.data$Longitude <- gsub("N/A", "NA", CC.data$Longitude)
  
  #Latitude_NA<-which(is.na(CC.data$Latitude))
  CC.data$Latitude <-as.numeric((as.character(CC.data$Latitude)))
  #Latitude_NA2<-which(is.na(CC.data$Latitude))
  #NewNAs<-setdiff(Latitude_NA2, Latitude_NA)
  #Row189 is not being recognized-fixed, it had an space
  
  #Longitude_NA<-which(is.na(CC.data$Longitude))
  CC.data$Longitude <-as.numeric((as.character(CC.data$Longitude)))
  #Longitude_NA2<-which(is.na(CC.data$Longitude))
  #NewNAs<-setdiff(Longitude_NA2, Longitude_NA)
  
  
  CC.data$Temperature_C <-
    as.numeric((as.character(CC.data$Temperature_C)))
  Temperature_NA2<-which(is.na(CC.data$Temperature_C))
  # 4 temp values not available in the original data
  
  CC.data$TA <-as.numeric((as.character(CC.data$TA)))
  #Row 730 does not have TA, pH, pCO2 or Aragonite 
  
  CC.data$DIC <-as.numeric((as.character(CC.data$DIC)))
  
  CC.data$pH <-as.numeric((as.character(CC.data$pH)))
  TA_NA<-which(is.na(CC.data$pH))
  # rows 31  32 663 664 730
  
  CC.data$pCO2 <-as.numeric((as.character(CC.data$pCO2)))
  CC.data$Aragonite_Sat_W<-
    as.numeric((as.character(CC.data$Aragonite_Sat_W)))
  
 # CC.data$DIC[CC.data$DIC == 4574.590 ] <- 2043.1832
  
  CC.data$ID<-paste(CC.data$SiteID, "_", CC.data$CTDID )
  
  #Remove Miami data
  #CC.data<-subset(CC.data,CC.data$Region!="SEFCRI")
  
  # #Get only FLK data#
  # FLK.data<-subset(CC.data,CC.data$Region=="FLK")
  
```

# Order seasons and months

```{r, include=FALSE}
CC.data$Season<-factor(CC.data$Season, levels = c(
                        "Winter", "Spring", "Summer", "Fall"))

#CC.data$Month<-factor(CC.data$Month, levels = month.name)
CC.data$Month<-factor(CC.data$Month, levels = c( "May","June", "July",
                                                 "August","September","October",
                                                 "November","December",
                                                 "January", "February","March","April"))
#summary(CC.data$Month)

```


# Subste the data

```{r}
  #Get only FLK data#
  FLK.data<-subset(CC.data,CC.data$Region=="FLK")
  Metadata<-read.csv("Data/FLKLocations.csv", header = T)
  
  FLK.data<-join(FLK.data,Metadata, 
                 type = "left", by="SiteID")
  
  FLK.data<-subset(FLK.data, FLK.data$Sub_region!="NA")
  
  FLK.data$Sub_region<-factor(FLK.data$Sub_region, levels = c(
                        "Biscayne", "UK", "MK", "LK"))

  FLK.data$Zone<-factor(FLK.data$Zone, levels = c(
                        "Inshore", "Mid channel", 
                        "Offshore", "Oceanic"))
  
  
  ## FOR NOW: remove weird 2019 values 
  QC.data<-subset(FLK.data, FLK.data$Aragonite_Sat_W<2)
  FLK.data<-FLK.data[!(FLK.data$ID  %in% QC.data$ID),]
  #write.csv(QC.data, "QC.data.csv")

  
  # Separate CalVal and Walton Smith data
  summary(FLK.data$Mission)
  CalVal.data<-subset(FLK.data, FLK.data$Mission=="CalVal")
  WS.data<-subset(FLK.data, FLK.data$Mission=="WaltonSmith")
  
```

# 1. Data available

## Locations (All samples)

```{r MapINformation, include=FALSE}
# Map information
# Add info from the sampling stations
Locations <- FLK.data %>% select(Latitude,
                                Longitude, 
                                Sub_region, 
                                SiteID)
Locations$GPS<-paste(Locations$Latitude,
                     "-", 
                     Locations$Longitude)

Locations<-unique(Locations)

GPS.Sites <- ddply (FLK.data, .(Sub_region, SiteID),summarise,
                Lat = mean (Latitude, na.rm = F), 
                Lon = mean (Longitude, na.rm = F),
                number = n())

#Change color depending on type of data?
  #stations$Site<-as.numeric(stations$Site)
  # pal <- colorNumeric(palette = "YlOrRd", 
                      #domain = stations$Site)
  
  #stations$Site<-as.factor(stations$Site)
  #pal.gen <- colorFactor(palette = "Set1",
  #                       domain = Locations$Location)
  pal.gen <- colorFactor(palette = "Set1",
                         domain = CC.data$Zone)
```


```{r makeAmap, echo=FALSE}

leaflet(FLK.data, height = '400px') %>% 
  addTiles() %>%
  addProviderTiles(providers$Esri.WorldImagery)%>%
  #addProviderTiles(providers$OpenStreetMap) %>% 
  #addMarkers(icon=coral.icon) %>% 
  addCircleMarkers(lng = ~Longitude, lat = ~Latitude, 
                   stroke = TRUE, 
                   radius = sqrt(GPS.Sites$number), 
                   fillOpacity = 1,
                   color = ~pal.gen(Zone),
                   label = ~ID,
                   labelOptions = labelOptions(
                     noHide = F, direction = "bottom",
                     textOnly = TRUE,
                     style = list(
        "color" = "white")))  %>%
  addLegend(position = "topright",
            pal = pal.gen, 
            values = ~Zone, opacity = 1) %>%
  fitBounds(lng1=-81.20, lat=26, lng2=-80.5, lat2=24)
  
```
Map of the sites were samples are collected

## 2. Walton smith - all zones

## Locations (All samples)

```{r WS.Map, include=FALSE}
# Map information

WS.GPS.Sites <- ddply (WS.data, .(Sub_region, Zone, SiteID),summarise,
                Lat = mean (Latitude, na.rm = F), 
                Lon = mean (Longitude, na.rm = F),
                number = n())

#Change color depending on type of data?
  #stations$Site<-as.numeric(stations$Site)
  # pal <- colorNumeric(palette = "YlOrRd", 
                      #domain = stations$Site)
  
  #stations$Site<-as.factor(stations$Site)
  #pal.gen <- colorFactor(palette = "Set1",
  #                       domain = Locations$Location)
  pal.gen <- colorFactor(palette = "Set1",
                         domain = WS.GPS.Sites$Zone)
```


```{r WSmap, echo=FALSE}

leaflet(WS.GPS.Sites, height = '500px') %>% 
  addTiles() %>%
  addProviderTiles(providers$Esri.WorldImagery)%>%
  #addProviderTiles(providers$OpenStreetMap) %>% 
  #addMarkers(icon=coral.icon) %>% 
  addCircleMarkers(lng = ~Lon, lat = ~Lat, 
                   stroke = TRUE, 
                   #radius = sqrt(WS.GPS.Sites$number), 
                   fillOpacity = 1,
                   color = ~pal.gen(Zone),
                   label = ~SiteID,
                   labelOptions = labelOptions(
                     noHide = F, direction = "bottom",
                     textOnly = TRUE,
                     style = list(
        "color" = "white")))  %>%
  addLegend(position = "topright",
            pal = pal.gen, 
            values = ~Zone, opacity = 1) %>%
  fitBounds(lng1=-81.20, lat=26, lng2=-80.5, lat2=24)
  
```
Map of the sites were samples are collected


### 2.1. nTA and nDIC relation

```{r}
TA_DIC<- ggplot(WS.data, aes (nDIC, nTA)) + 
  
  theme_bw() +
  scale_y_continuous(#limits = c(1700,2900),
                     #expand = c(0, 0),
                     #breaks = seq(1800, 2800, 100),
                    name="nTA") +
  scale_x_continuous(# limits = c(1600, 2600),
                     # expand = c(0, 0),
                     # breaks = seq(1500,2600,100),
                      name="nDIC")+
  
theme(legend.position="top",
          plot.background=element_blank(),
          axis.text.x = element_text(angle = 90, vjust = 0.5),
          panel.grid.major.y = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          legend.box.background = element_rect(),
          panel.background =element_rect(fill = NA, 
                                         color = "black")
          )+
  geom_point(aes (fill=Precipitation, shape=Zone),
             size=3, alpha=0.5)+
  scale_shape_manual(values=c(21, 21, 24, 25))+
  geom_smooth(method = "lm", colour="black")

```


```{r, fig.height=8.8, fig.width=8.8}

TA_DIC +
  facet_grid(~Sub_region)

TA_DIC +
  facet_grid(Zone~Sub_region)

```


**Figure 3:** Linear regressions of total alkalinity (nTA) as a function of disolved inorganic carbon (nDIC).


```{r}
 # Individual LR for each region
    
    TA_DIC_lm_Subreg <- FLK.data %>% 
                    group_by(Mission, Sub_region, Zone) %>%
                    do({model = lm(nTA~nDIC, data=.)  
                    # create model
                    data.frame(tidy(model), # get coefficient info
                    glance(model))})        # get model info

    kable(as.data.frame(TA_DIC_lm_Subreg[,1:8], format = "markdown"),
          caption = "Table 3: nTA vs nDIC equations", digits = 3)
```

* Higher slopes -> a higher NCC:NCP? = Lower and Middle keys, then Miami, then Upper keys


### 2.2 Aragonite 

* By months (seasonality)

```{r}
Aragonite_months<- ggplot(WS.data,
                          aes(x=Month, y=Aragonite_Sat_W)) +
  
  theme_bw() +
  scale_y_continuous(limits = c(1,5.5),
                      name=(expression ("Aragonite saturation state "~Omega)),
                      breaks = seq(1, 5, 1),  
                       expand = c(0, 0)) +
  #scale_x_date(name="Date",
               #labels = date_format("%M/%Y"),
               #limits = c(-1,114),
   #            expand = c(0, 0),
    #           breaks ="6 months")+
  
geom_boxplot()+
geom_point(aes(fill=Precipitation), shape=21, alpha=0.5)+ 
geom_abline(slope = 0, intercept = 3, color="gray", linetype=2)+
  
theme(legend.position="top",
      legend.direction = "horizontal",
      # legend.title = element_blank(),
          plot.background=element_blank(),
          axis.text.x = element_text(angle = 90, vjust = 0.5),
          panel.grid.major.y = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          legend.box.background = element_rect(),
          panel.background =element_rect(fill = NA, color = "black")
          ) #+
  #scale_fill_gradient(low = "red", high = "blue", na.value = NA)
  
Aragonite_months+facet_grid(Zone~Sub_region)
```

### 2.3 nTA 

* By months (seasonality)

```{r}
nTA_months<- ggplot(WS.data,
                          aes(x=Month, y=nTA)) +
  
  theme_bw() +
  scale_y_continuous(#limits = c(1,5.5),
                      name=(expression ("nTA")),
                      #breaks = seq(1, 5, 1),  
                      expand = c(0, 0)) +
  #scale_x_date(name="Date",
               #labels = date_format("%M/%Y"),
               #limits = c(-1,114),
   #            expand = c(0, 0),
    #           breaks ="6 months")+
  
geom_boxplot()+
geom_point(aes(fill=Precipitation), shape=21, alpha=0.5, size=0.8)+ 
geom_abline(slope = 0, intercept = 3, color="gray", linetype=2)+
  
theme(legend.position="top",
      legend.direction = "horizontal",
      legend.title = element_blank(),
          plot.background=element_blank(),
          axis.text.x = element_text(angle = 90, vjust = 0.5),
          panel.grid.major.y = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          legend.box.background = element_rect(),
          panel.background =element_rect(fill = NA, color = "black")
          ) #+
  #scale_fill_gradient(low = "red", high = "blue", na.value = NA)
  
nTA_months + facet_grid(Zone~Sub_region)
```


### 2.4 nDIC 

* By months (seasonality)

```{r}
nDIC_months<- ggplot(WS.data,
                          aes(x=Month, y=nTA)) +
  
  theme_bw() +
  scale_y_continuous(#limits = c(1,5.5),
                      name=(expression ("nDIC")),
                      #breaks = seq(1, 5, 1),  
                      expand = c(0, 0)) +
  #scale_x_date(name="Date",
               #labels = date_format("%M/%Y"),
               #limits = c(-1,114),
   #            expand = c(0, 0),
    #           breaks ="6 months")+
  
geom_boxplot()+
geom_point(aes(fill=Precipitation), shape=21, alpha=0.5, size=0.8)+ 
#geom_jitter(aes(fill=factor(Year)),
 #          shape=21, alpha=0.8)+ 
#geom_abline(slope = 0, intercept = 3, color="gray", linetype=2)+
  
theme(legend.position="top",
      legend.direction = "horizontal",
      #legend.title = element_blank(),
          plot.background=element_blank(),
          axis.text.x = element_text(angle = 90, vjust = 0.5),
          panel.grid.major.y = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          legend.box.background = element_rect(),
          panel.background =element_rect(fill = NA, color = "black")
          ) #+
  #scale_fill_gradient(low = "red", high = "blue", na.value = NA)
  
nDIC_months + facet_grid(Zone~Sub_region)
```

### 2.5 Data available

```{r, echo=FALSE}
Cases_WS<-WS.data %>% count(Month,
                            Sub_region,
                            Zone,
                            sort = F)

Cases_WS<-as.data.frame(Cases_WS %>%
                   pivot_wider(names_from = Month,
                   values_from = n))

kable(as.data.frame(Cases_WS, format = "markdown"), 
      longtable = TRUE)
```


```{r, echo=FALSE}
Aragonite.month <- ddply (WS.data, .(Month, Sub_region, Zone),
                          summarise,
                #Amin = min (Aragonite_Sat_W, na.rm = F), 
                #Amax = max (Aragonite_Sat_W, na.rm = F),
                Amean = mean (Aragonite_Sat_W, na.rm = F)#, 
                #Asd = sd (Aragonite_Sat_W, na.rm = F)
                )
Aragonite.month

Aragonite.month<-as.data.frame(Aragonite.month %>%
                   pivot_wider(names_from = Month,
                   values_from = c(Amean)))

kable(as.data.frame(Aragonite.month, format = "markdown"), 
      longtable = TRUE, digits=2 )
```


## 3. Walton smith - Inshore and Middle channel vs (Offsshore + Oceanic)

```{r}
  WS.open<-subset(WS.data, WS.data$Zone=="Offshore"|WS.data$Zone=="Oceanic")
  WS.open$Date<-as.Date(WS.open$Date, "%Y-%m-%d")
 
  WS.reef<-subset(WS.data, WS.data$Zone=="Inshore"|WS.data$Zone=="Mid channel")
  WS.reef$Date<-as.Date(WS.reef$Date, "%Y-%m-%d")
```

* Get the oceanic / offshore mean values per monty and substract them from the reef data

```{r}

# Reef data
nTA.month.open <- ddply (WS.open, .(Sub_region, Month),summarise,
                nTA_mo = mean (nTA, na.rm = F))

nDIC.month.open <- ddply (WS.open, .(Sub_region, Month),summarise,
                nDIC_mo = mean (nDIC, na.rm = F))

WS.reef<-join(WS.reef,nTA.month.open, 
                 type = "left", by=c("Month", "Sub_region"))

WS.reef<-join(WS.reef, nDIC.month.open, 
                 type = "left", by=c("Month", "Sub_region"))

# Delta nTA
WS.reef$dnTA<-WS.reef$nTA-WS.reef$nTA_mo

# Delta nDIC
WS.reef$dnDIC<-WS.reef$nDIC-WS.reef$nDIC_mo

```

### 3.1. dnTA and dnDIC relation

```{r}
dnTA_dnDIC<- ggplot(WS.reef, aes (dnDIC, dnTA)) + 
  
  theme_bw() +
  scale_y_continuous(#limits = c(1700,2900),
                     #expand = c(0, 0),
                     #breaks = seq(1800, 2800, 100),
                    name=expression(Delta~"nTA")) +
  scale_x_continuous(# limits = c(1600, 2600),
                     # expand = c(0, 0),
                     # breaks = seq(1500,2600,100),
                      name=expression(Delta~"nDIC"))+
  
theme(legend.position="top",
          plot.background=element_blank(),
          axis.text.x = element_text(angle = 90, vjust = 0.5),
          panel.grid.major.y = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          legend.box.background = element_rect(),
          panel.background =element_rect(fill = NA, 
                                         color = "black")
          )+
  geom_point(aes(fill=Precipitation), size=3, alpha=0.5, shape=21)+
  #scale_shape_manual(values=c(21, 24))+
  geom_smooth(method = "lm", colour="black")+
  geom_abline(slope = 0, intercept = 0, linetype=2, colour="gray")+
  geom_vline(xintercept = 0, linetype=2, colour="gray")

```


```{r, fig.height=8.8, fig.width=8.8}

#dnTA_dnDIC + facet_grid(~Sub_region)

dnTA_dnDIC +
  facet_grid(Zone~Sub_region)

```


```{r}
 # Individual LR for each region
    
    dnTA_dnDIC_lm_Subreg <- WS.reef %>% 
                    group_by(Sub_region, Zone) %>%
                    do({model = lm(dnTA~dnDIC, data=.)  
                    # create model
                    data.frame(tidy(model), # get coefficient info
                    glance(model))})        # get model info

    kable(as.data.frame(dnTA_dnDIC_lm_Subreg[,1:8], format = "markdown"),
          caption = "Table 3: nTA vs nDIC equations", digits = 3)
```

* Higher slopes -> a higher NCC:NCP? = Lower and Middle keys, then Miami, then Upper keys

### 3.2 seasonal Aragonite 

* By months (seasonality)

```{r}
Aragonite_months<- ggplot(WS.reef,
                          aes(x=Month, y=Aragonite_Sat_W)) +
  
  theme_bw() +
  scale_y_continuous(limits = c(1.5,5.5),
                       name=paste("Aragonite Saturation state (\u03a9)") ,
                       breaks = seq(2, 5, 1),  
                       expand = c(0, 0)) +
  #scale_x_date(name="Date",
               #labels = date_format("%M/%Y"),
               #limits = c(-1,114),
   #            expand = c(0, 0),
    #           breaks ="6 months")+
  
geom_boxplot()+
geom_point(aes(fill=Precipitation),
          shape=21, alpha=0.5)+ 
geom_abline(slope = 0, intercept = 3, color="gray", linetype=2)+
  
theme(legend.position="top",
      legend.direction = "horizontal",
      #legend.title = element_blank(),
          plot.background=element_blank(),
          axis.text.x = element_text(angle = 90, vjust = 0.5),
          panel.grid.major.y = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          legend.box.background = element_rect(),
          panel.background =element_rect(fill = NA, color = "black")
          ) #+
  #scale_fill_gradient(low = "red", high = "blue", na.value = NA)
  
Aragonite_months+facet_grid(Zone~Sub_region)
```

### 3.3 seasonal delta nTA 

```{r}
dnTA_months<- ggplot(WS.reef,
                          aes(x=Month, y=dnTA)) +
  
  theme_bw() +
  scale_y_continuous(#limits = c(1,5.5),
                      name=(expression (Delta~ "nTA")),
                       #breaks = seq(1, 5, 1),  
                       expand = c(0, 0)) +
  #scale_x_date(name="Date",
               #labels = date_format("%M/%Y"),
               #limits = c(-1,114),
   #            expand = c(0, 0),
    #           breaks ="6 months")+
  
geom_boxplot()+
geom_point(aes(fill=Precipitation),
          shape=21, alpha=0.5)+ 
geom_abline(slope = 0, intercept = 3, color="gray", linetype=2)+
  
theme(legend.position="top",
      legend.direction = "horizontal",
      #legend.title = element_blank(),
          plot.background=element_blank(),
          axis.text.x = element_text(angle = 90, vjust = 0.5),
          panel.grid.major.y = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          legend.box.background = element_rect(),
          panel.background =element_rect(fill = NA, color = "black")
          ) #+
  #scale_fill_gradient(low = "red", high = "blue", na.value = NA)
  
dnTA_months+facet_grid(Zone~Sub_region)
```


### 3.4 seasonal delta nDIC

```{r}
dnDIC_months<- ggplot(WS.reef,
                          aes(x=Month, y=dnDIC)) +
  
  theme_bw() +
  scale_y_continuous(#limits = c(1,5.5),
                       name=(expression (Delta~ "nDIC")),
                       #breaks = seq(1, 5, 1),  
                       expand = c(0, 0)) +
  #scale_x_date(name="Date",
               #labels = date_format("%M/%Y"),
               #limits = c(-1,114),
   #            expand = c(0, 0),
    #           breaks ="6 months")+
  
geom_boxplot()+
geom_point(aes(fill=Precipitation),
          shape=21, alpha=0.5)+ 
geom_abline(slope = 0, intercept = 0, color="gray", linetype=2)+
  
theme(legend.position="top",
      legend.direction = "horizontal",
      #legend.title = element_blank(),
          plot.background=element_blank(),
          axis.text.x = element_text(angle = 90, vjust = 0.5),
          panel.grid.major.y = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          legend.box.background = element_rect(),
          panel.background =element_rect(fill = NA, color = "black")
          ) #+
  #scale_fill_gradient(low = "red", high = "blue", na.value = NA)
  
dnDIC_months + facet_grid(Zone~Sub_region)
```


* By years (trends) -> need to remove sites not sampled across timepoints


# 4. Oceanic-Offshore longterm trends in FLK

## 4.1 LMER (do not use)

```{r}
Aragonite_Reference<- ggplot(WS.open,
                          aes(x=Date, y=Aragonite_Sat_W)) +
  
  theme_bw() +
  scale_y_continuous(#limits = c(0,5.5),
                       name=("Aragonite Saturation") ,
                       #breaks = seq(0, 5, 1),  
                       expand = c(0, 0)) +
  scale_x_date(name="Date",
               #labels = date_format("%M/%Y"),
               #limits = c(-1,114),
               expand = c(0, 0),
               breaks ="6 months")+

geom_smooth(method = "lm")+  
geom_point(aes(fill=factor(Year)), shape=21, alpha=0.5)+
geom_abline(slope = 0, intercept = 3, color="gray", linetype=2)+
  
theme(legend.position="top",
      legend.direction = "horizontal",
      legend.title = element_blank(),
          plot.background=element_blank(),
          axis.text.x = element_text(angle = 90, vjust = 0.5),
          panel.grid.major.y = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          legend.box.background = element_rect(),
          panel.background =element_rect(fill = NA, color = "black")
          )
Aragonite_Reference  

Aragonite_Reference + facet_grid(~Season)
Aragonite_Reference + facet_grid(~Precipitation)
```

NOTE: Only month is significant (no region (UK, MK, LK), no Zone (oof-shore vs oceanic))

```{r}

Reference_LM<-lmer(Aragonite_Sat_W~Year + 
                                  (1|Month) +
                                  (1|Sub_region) +
                                  (1|Zone), data=WS.open)
summary(Reference_LM)    
anova(Reference_LM)
ranova(Reference_LM)
step(Reference_LM)

Oceanic_model<-Reference_LM
Oceanic_model

Arg_off_lm <- WS.open %>% 
                    group_by(Zone) %>%
                    do({model = lm(Aragonite_Sat_W~Year, data=.)  
                    # create model
                    data.frame(tidy(model), # get coefficient info
                    glance(model))})        # get model info

    kable(as.data.frame(Arg_off_lm[,1:8], format = "markdown"),
          caption = "Table 3: nTA vs nDIC equations", digits = 3)
```

**Oceanic Aragonite** = -0.05803  Y +  120.84919  

* By years (trends) -> need to remove sites not sampled across timepoints


## 4.2 means (do not use)

```{r}
Aragonite.month <- ddply (WS.open, .(Season, Year),
                          summarise,
                #Amin = min (Aragonite_Sat_W, na.rm = F), 
                #Amax = max (Aragonite_Sat_W, na.rm = F),
                Amean = mean (Aragonite_Sat_W, na.rm = F)#, 
                #Asd = sd (Aragonite_Sat_W, na.rm = F)
                )
Aragonite.month

Aragonite_Reference2<- ggplot(Aragonite.month,
                          aes(x=Year, y=Amean)) +
  
  theme_bw() +
  scale_y_continuous(#limits = c(0,5.5),
                       name=("Aragonite Saturation") ,
                       #breaks = seq(0, 5, 1),  
                       expand = c(0, 0)) +
  #scale_x_date(name="Date",
               #labels = date_format("%M/%Y"),
               #limits = c(-1,114),
   #            expand = c(0, 0),
    #           breaks ="6 months")+

geom_smooth(method = "lm")+  
geom_point(aes(fill=factor(Year)), shape=21, alpha=0.5)+
geom_abline(slope = 0, intercept = 3, color="gray", linetype=2)+
  
theme(legend.position="top",
      legend.direction = "horizontal",
      legend.title = element_blank(),
          plot.background=element_blank(),
          axis.text.x = element_text(angle = 90, vjust = 0.5),
          panel.grid.major.y = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          legend.box.background = element_rect(),
          panel.background =element_rect(fill = NA, color = "black")
          )
Aragonite_Reference2  

Aragonite_Reference + facet_wrap(~Season)

```


#5. Inshore-mid reef longterm trends in FLK

```{r}
Aragonite_reef<- ggplot(WS.reef,
                          aes(x=Date, y=Aragonite_Sat_W)) +
  
  theme_bw() +
  scale_y_continuous(#limits = c(0,5.5),
                       name=("Aragonite Saturation") ,
                       #breaks = seq(0, 5, 1),  
                       expand = c(0, 0)) +
  scale_x_date(name="Date",
               #labels = date_format("%M/%Y"),
               #limits = c(-1,114),
               expand = c(0, 0),
               breaks ="6 months")+

geom_smooth(method = "lm")+  
geom_point(aes(fill=factor(Year)), shape=21, alpha=0.5)+
geom_abline(slope = 0, intercept = 3, color="gray", linetype=2)+
  
theme(legend.position="top",
      legend.direction = "horizontal",
      legend.title = element_blank(),
          plot.background=element_blank(),
          axis.text.x = element_text(angle = 90, vjust = 0.5),
          panel.grid.major.y = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          legend.box.background = element_rect(),
          panel.background =element_rect(fill = NA, color = "black")
          )
Aragonite_reef  

Aragonite_reef+ facet_grid(~Season)
Aragonite_reef + facet_grid(~Precipitation)
```

NOTE: Only month is significant (no region (UK, MK, LK), no Zone (oof-shore vs oceanic))

```{r}

Reef_LM<-lmer(Aragonite_Sat_W~Year + 
                                  (1|Month) +
                                  (1|Sub_region) +
                                  (1|Zone), data=WS.reef)
summary(Reef_LM)    
anova(Reef_LM)
ranova(Reef_LM)
step(Reef_LM)

Reef_model<-Reef_LM
Reef_model

Arg_off_lm <- WS.open %>% 
                    group_by(Zone) %>%
                    do({model = lm(Aragonite_Sat_W~Year, data=.)  
                    # create model
                    data.frame(tidy(model), # get coefficient info
                    glance(model))})        # get model info

    kable(as.data.frame(Arg_off_lm[,1:8], format = "markdown"),
          caption = "Table 3: nTA vs nDIC equations", digits = 3)
```

**Oceanic Aragonite** = -0.05803  Y +  120.84919  

**Note:** data from 2012-2015 is only Upper Keys! Miami, MK and LK start in 2016


# Notes on samples

* Get offshore values for analysis (NCP and NCC)
* Residence time with Heidi
* Get better location information/metadata
  - Reefs vs no reefs
* Choose timeframe/seasonality -> question driven
